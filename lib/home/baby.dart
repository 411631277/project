import 'dart:convert';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:http/http.dart' as http;
import 'package:intl/intl.dart';
import 'package:logger/logger.dart';
import 'dart:math' as math;

final Logger logger = Logger();

final TextEditingController babyNameController = TextEditingController();
final TextEditingController babyBirthController = TextEditingController();
final TextEditingController babyGenderController = TextEditingController();
final TextEditingController babyWeightController = TextEditingController();
final TextEditingController babyHeightController = TextEditingController();

class BabyWidget extends StatefulWidget {
  final String userId; // üîπ ÂæûÁôªÂÖ•ÊàñË®ªÂÜäÊôÇÂÇ≥ÂÖ•ÁöÑ userId
  final bool isManUser;
  const BabyWidget({super.key, required this.userId, required this.isManUser});

  @override
  State<BabyWidget> createState() => _BabyWidgetState();
}

class _BabyWidgetState extends State<BabyWidget> {
  bool hasSpecialCondition = false; // ÊòØÂê¶ÊúâÁâπÊÆäÁãÄÊ≥Å
  TextEditingController specialConditionController =
      TextEditingController(); // Ëº∏ÂÖ•Ê°ÜÊéßÂà∂Âô®

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;

    return Scaffold(
  body: GestureDetector(
    onTap: () {
      FocusScope.of(context).unfocus(); // ÈªûÊìäÁ©∫ÁôΩËôïÊî∂Ëµ∑ÈçµÁõ§
    },
    child: SingleChildScrollView(
     
      child: Container(
        width: screenWidth,
        height: screenHeight,
        decoration: const BoxDecoration(
          color: Color.fromRGBO(233, 227, 213, 1),
        ),
        child: Stack(
          children: <Widget>[
          // ---------- ÂéüÊú¨ÁöÑ Scrollable Ê¨Ñ‰ΩçÊîæÈÄôË£° ----------
          SingleChildScrollView(
            padding: const EdgeInsets.symmetric(vertical: 32),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Padding(
                  padding: const EdgeInsets.only(left: 24, bottom: 16),
                  child: Image.asset(
                    'assets/images/Baby.png',
                    width: 80,
                  ),
                ),
                _buildInputRow('ÂßìÂêç', babyNameController),
                _buildDatePickerField('ÁîüÊó•', babyBirthController),
                _buildGenderSelector(),
                _buildWeightPickerField('Âá∫ÁîüÈ´îÈáç', babyWeightController),
                _buildHeightPickerField('Âá∫ÁîüË∫´È´ò', babyHeightController),
                const SizedBox(height: 32),
              ],
            ),
          ),

          // ---------- ÂØ∂ÂØ∂Âá∫ÁîüÊòØÂê¶ÊúâÁâπÊÆäÁãÄÊ≥Å (Ë∑üÂéüÁâà‰∏ÄÊ®£) ----------
          Positioned(
            top: screenHeight * 0.60,
            left: screenWidth * 0.25,
            child: const Text(
              'ÂØ∂ÂØ∂Âá∫ÁîüÊòØÂê¶ÊúâÁâπÊÆäÁãÄÊ≥Å',
              style: TextStyle(
                fontSize: 18,
                color: Color.fromRGBO(147, 129, 108, 1),
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          Positioned(
            top: screenHeight * 0.65,
            left: screenWidth * 0.22,
            child: Row(
              children: [
                Checkbox(
                  value: !hasSpecialCondition,
                  onChanged: (v) {
                    setState(() {
                      hasSpecialCondition = false;
                      specialConditionController.clear();
                    });
                  },
                ),
                const Text('ÁÑ°',
                    style: TextStyle(
                        fontSize: 18, color: Color.fromRGBO(147, 129, 108, 1))),
                SizedBox(width: screenWidth * 0.2),
                Checkbox(
                  value: hasSpecialCondition,
                  onChanged: (v) => setState(() => hasSpecialCondition = true),
                ),
                const Text('Êúâ',
                    style: TextStyle(
                        fontSize: 18, color: Color.fromRGBO(147, 129, 108, 1))),
              ],
            ),
          ),
          if (hasSpecialCondition)
            Positioned(
              top: screenHeight * 0.70,
              left: screenWidth * 0.15,
              child: SizedBox(
                width: screenWidth * 0.7,
                child: TextField(
                  controller: specialConditionController,
                  decoration: const InputDecoration(
                    labelText: "Ë´ãËº∏ÂÖ•ÁâπÊÆäÁãÄÊ≥Å",
                    filled: true,
                    fillColor: Colors.white,
                    border: OutlineInputBorder(),
                  ),
                ),
              ),
            ),

          // ---------- Â°´ÂØ´ÂÆåÊàê & ËøîÂõûÊåâÈàï (ÂêåÂéüÁâà) ----------
          Positioned(
            top: screenHeight * 0.80,
            left: screenWidth * 0.3,
            child:
                _buildButton(context, 'Â°´ÂØ´ÂÆåÊàê', Colors.brown.shade400, () async {
              // ÂëºÂè´ _saveBabyDataÔºåÂ∞áÊâÄÊúâÊ¨Ñ‰ΩçÂÇ≥ÂÖ•
              _saveBabyData(
                widget.userId,
                widget.isManUser,
                babyNameController.text,
                babyBirthController,
                babyGenderController,
                babyWeightController,
                babyHeightController,
                hasSpecialCondition,
                specialConditionController,
              );
              if (!mounted) return;
              Navigator.pushNamed(
                context,
                '/BabyAccWidget',
                arguments: {
                  'userId': widget.userId,
                  'isManUser': widget.isManUser,
                },
              );
            }),
          ),
          Positioned(
            top: screenHeight * 0.75,
            left: screenWidth * 0.1,
            child: GestureDetector(
              onTap: () => Navigator.pop(context),
              child: Transform.rotate(
                angle: math.pi,
                child: Container(
                  width: screenWidth * 0.15,
                  height: screenHeight * 0.15,
                  decoration: const BoxDecoration(
                    image: DecorationImage(
                      image: AssetImage('assets/images/back.png'),
                      fit: BoxFit.fitWidth,
                    ),
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    ))));
  }

  // **ËøîÂõûÊåâÈàï**

  Widget _buildInputRow(String label, TextEditingController controller) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32.0, vertical: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          SizedBox(
            width: 90,
            child: Text(
              label,
              style: const TextStyle(
                fontSize: 18,
                color: Color.fromRGBO(147, 129, 108, 1),
              ),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Align(
              alignment: Alignment.centerRight,
              child: SizedBox(
                width: 180,
                child: TextField(
                  controller: controller,
                  decoration: const InputDecoration(
                    filled: true,
                    fillColor: Colors.white,
                    border: OutlineInputBorder(),
                    contentPadding:
                        EdgeInsets.symmetric(vertical: 8, horizontal: 10),
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildButton(
      BuildContext context, String text, Color color, VoidCallback onPressed) {
    return SizedBox(
      width: MediaQuery.of(context).size.width * 0.4,
      height: 40,
      child: ElevatedButton(
        style: ElevatedButton.styleFrom(
          backgroundColor: color,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
        ),
        onPressed: onPressed,
        child: Text(
          text,
          style: const TextStyle(
            color: Colors.white,
            fontSize: 18,
            fontFamily: 'Inter',
          ),
        ),
      ),
    );
  }

  Widget _buildGenderSelector() {
  return Padding(
    padding: const EdgeInsets.symmetric(horizontal: 32.0, vertical: 8),
    child: Row(
      crossAxisAlignment: CrossAxisAlignment.center,
      children: [
        SizedBox(
          width: 90,
          child: Text(
            'ÊÄßÂà•',
            style: const TextStyle(
              fontSize: 18,
              color: Color.fromRGBO(147, 129, 108, 1),
            ),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: Wrap(
            alignment: WrapAlignment.spaceEvenly,
            children: [
              Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Radio<String>(
                    value: 'Áî∑Áîü',
                    groupValue: babyGenderController.text,
                    onChanged: (value) {
                      setState(() {
                        babyGenderController.text = value ?? '';
                      });
                    },
                  ),
                  const Text('Áî∑Áîü'),
                ],
              ),
              Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Radio<String>(
                    value: 'Â•≥Áîü',
                    groupValue: babyGenderController.text,
                    onChanged: (value) {
                      setState(() {
                        babyGenderController.text = value ?? '';
                      });
                    },
                  ),
                  const Text('Â•≥Áîü'),
                ],
              ),
            ],
          ),
        ),
      ],
    ),
  );
}

  Widget _buildWeightPickerField(
      String label, TextEditingController controller) {
    return _buildPickerRow(label, controller, 0.0, 7.0, 0.1, 'kg');
  }

  Widget _buildHeightPickerField(
      String label, TextEditingController controller) {
    return _buildPickerRow(label, controller, 20, 90, 1, 'cm');
  }

  Widget _buildPickerRow(String label, TextEditingController controller,
      double start, double end, double step, String unit) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32.0, vertical: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          SizedBox(
            width: 90,
            child: Text(
              label,
              style: const TextStyle(
                fontSize: 18,
                color: Color.fromRGBO(147, 129, 108, 1),
              ),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Align(
              alignment: Alignment.centerRight,
              child: SizedBox(
                width: 180,
                child: GestureDetector(
                  onTap: () =>
                      _showPicker(context, controller, start, end, step, unit),
                  child: AbsorbPointer(
                    child: TextField(
                      controller: controller,
                      decoration: const InputDecoration(
                        filled: true,
                        fillColor: Colors.white,
                        border: OutlineInputBorder(),
                        contentPadding:
                            EdgeInsets.symmetric(vertical: 8, horizontal: 10),
                      ),
                    ),
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _showPicker(BuildContext context, TextEditingController controller,
      double start, double end, double step, String unit) {
    final values = <String>[];
    for (double val = start; val <= end; val += step) {
      values.add(val.toStringAsFixed(step < 1 ? 1 : 0));
    }

    int defaultIndex = ((end - start) / step / 2).round(); // È†êË®≠‰∏≠ÈñìÂÄº
    int initialIndex = controller.text.isNotEmpty
        ? values.indexWhere((v) => controller.text.contains(v))
        : defaultIndex;

    int selectedIndex = initialIndex;

    showModalBottomSheet(
      context: context,
      builder: (context) => SizedBox(
        height: 250,
        child: Column(
          children: [
            SizedBox(
              height: 200,
              child: CupertinoPicker(
                itemExtent: 40,
                scrollController:
                    FixedExtentScrollController(initialItem: initialIndex),
                onSelectedItemChanged: (index) {
                  selectedIndex = index; // Êö´Â≠òÈÅ∏Êìá
                },
                children:
                    values.map((e) => Center(child: Text('$e $unit'))).toList(),
              ),
            ),
            ElevatedButton(
              onPressed: () {
                controller.text =
                    '${values[selectedIndex]} $unit'; // ‚¨ÖÔ∏è ÂÉÖÂú®Êåâ‰∏ãÊåâÈàïÊôÇÊõ¥Êñ∞
                Navigator.pop(context);
              },
              child: const Text("Á¢∫ÂÆö"),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDatePickerField(String label, TextEditingController controller) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32.0, vertical: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          SizedBox(
            width: 90,
            child: Text(
              label,
              style: const TextStyle(
                fontSize: 18,
                color: Color.fromRGBO(147, 129, 108, 1),
              ),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Align(
              alignment: Alignment.centerRight,
              child: SizedBox(
                width: 180,
                child: TextField(
                  controller: controller,
                  readOnly: true,
                  decoration: const InputDecoration(
                    filled: true,
                    fillColor: Colors.white,
                    border: OutlineInputBorder(),
                    contentPadding:
                        EdgeInsets.symmetric(vertical: 8, horizontal: 10),
                  ),
                  onTap: () async {
                    DateTime? pickedDate = await showDatePicker(
                      context: context,
                      initialDate: DateTime.now(),
                      firstDate: DateTime(2000),
                      lastDate: DateTime.now(),
                      locale: const Locale("zh", "TW"),
                    );
                    if (pickedDate != null) {
                      String formattedDate =
                          "${pickedDate.year}Âπ¥${pickedDate.month}Êúà${pickedDate.day}Êó•";
                      setState(() {
                        controller.text = formattedDate;
                      });
                    }
                  },
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _saveBabyData(
    String userId,
    bool isManUser,
    String babyName,
    TextEditingController babyBirthController,
    TextEditingController babyGenderController,
    TextEditingController babyWeightController,
    TextEditingController babyHeightController,
    bool hasSpecialCondition,
    TextEditingController specialConditionController,
  ) async {
    try {
      String babyId = babyName.isNotEmpty
          ? babyName
          : DateTime.now().millisecondsSinceEpoch.toString();

      await FirebaseFirestore.instance
          .collection(isManUser ? 'Man_users' : 'users')
          .doc(userId)
          .collection('baby')
          .doc(babyId)
          .set({
        'ÂßìÂêç': babyName,
        'ÁîüÊó•': babyBirthController.text,
        'ÊÄßÂà•': babyGenderController.text,
        'Âá∫ÁîüÈ´îÈáç': babyWeightController.text,
        'Âá∫ÁîüË∫´È´ò': babyHeightController.text,
        'ÂØ∂ÂØ∂Âá∫ÁîüÁâπÊÆäÁãÄÊ≥Å':
            hasSpecialCondition ? specialConditionController.text : null,
        'Â°´ÂØ´ÊôÇÈñì': FieldValue.serverTimestamp(),
      });

      logger.i("‚úÖ ÂØ∂ÂØ∂Ë≥áË®äÂ∑≤ÂÑ≤Â≠òÂà∞ Firestore users/$userId/baby/$babyId");

      await sendBabyDataToMySQL(
        userId: userId,
        isManUser: isManUser,
        babyName: babyName,
        babyBirth: babyBirthController.text,
        babyGender: babyGenderController.text,
        babyWeight: babyWeightController.text,
        babyHeight: babyHeightController.text,
        hasSpecialCondition: hasSpecialCondition,
        babySolutionDetails: specialConditionController.text,
      );
    } catch (e) {
      logger.e("‚ùå _saveBabyData ÁôºÁîüÈåØË™§: $e");
    }
  }

  String formatBirthForMySQL(String text) {
    try {
      final parsed = DateFormat('yyyyÂπ¥MMÊúàddÊó•', 'zh_TW').parse(text);
      return DateFormat('yyyy-MM-dd').format(parsed);
    } catch (e) {
      return "";
    }
  }

  Future<void> sendBabyDataToMySQL({
    required String userId,
    required bool isManUser,
    required String babyName,
    required String babyBirth,
    required String babyGender,
    required String babyWeight,
    required String babyHeight,
    required bool hasSpecialCondition,
    String? babySolutionDetails,
  }) async {
    final uri = Uri.parse('http://163.13.201.85:3000/baby');

    final payload = <String, dynamic>{
      'baby_name': babyName,
      'baby_birthdate': formatBirthForMySQL(babyBirth),
      'baby_gender': babyGender,
      'baby_weight':
          double.tryParse(babyWeight.replaceAll(RegExp(r'[^0-9.]'), '')),
      'baby_height':
          double.tryParse(babyHeight.replaceAll(RegExp(r'[^0-9.]'), '')),
      'baby_solution': hasSpecialCondition ? 'Êúâ' : 'ÁÑ°',
    };

    if (hasSpecialCondition &&
        babySolutionDetails != null &&
        babySolutionDetails.isNotEmpty) {
      payload['baby_solution_details'] = babySolutionDetails;
    }

    final idInt = int.tryParse(userId);
    if (idInt == null) {
      logger.e("‚ùå userId ÁÑ°Ê≥ïËΩâÊàê intÔºö$userId");
      return;
    }
    if (isManUser) {
      payload['man_user_id'] = idInt;
    } else {
      payload['user_id'] = idInt;
    }

    try {
      final resp = await http.post(
        uri,
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode(payload),
      );

      if (resp.statusCode >= 200 && resp.statusCode < 300) {
        logger.i("‚úÖ ÂæåÁ´ØÂêåÊ≠•ÊàêÂäüÔºö${resp.body}");
      } else {
        logger.e("‚ùå ÂæåÁ´ØÂêåÊ≠•Â§±Êïó (${resp.statusCode})Ôºö${resp.body}");
      }
    } catch (e) {
      logger.e("üî• sendBabyDataToMySQL ÁôºÁîüÈåØË™§Ôºö$e");
    }
  }
}
